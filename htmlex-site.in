#! /bin/sh
# @configure_input@
#
# htmlex-site - a helper utility for make the skeleton of a htmlex site
# Copyright (C) 2001 David A. Capello
#
# http://htmlex.sourceforge.net
#

echo "htmlex-site @VERSION@"

# get the user name

username=`cat /etc/passwd | sed -e "/^$USER\:/p;D" | cut -d: -f5 | cut -d, -f1`

# obtains a line of text from the user

get_option() {
  read -p "$1 [$2]: " value
  if test ! "$value" ; then value=$2 ; fi
  echo $value
}

# creates a new directory

make_dir() {
  if [ ! -d "$1" ] ; then
    mkdir "$1"
    echo "Building: $1/ ..."
#  else
#    echo "Warning: $1/ exists .."
#    read -p "Continue [y]/n?" value
#    if [ "$value" == "n" ] ; then exit 1 ; fi
  fi
}

# get main site information

dir=`get_option "Directory name" "$HOSTNAME"`
author=`get_option "Author name" "$username"`
address=`get_option "Author address" "$USER@$HOSTNAME"`
date=`get_option "Copyright year" "\`date +%Y\`"`

# get system configuration

html=`get_option "HTML extension" html`
htex=`get_option "htmlex extension" htex`
jpeg=`get_option "JPEG extension" jpg`

autoconv=`get_option "Automatic xpm -> $jpeg conversion?" n`

if [ "$autoconv" == "y" ] ; then
  xpm=`get_option "X11 pixmap extension" xpm`
fi

# make the directory struct

make_dir $dir
make_dir $dir/data
make_dir $dir/data/index
make_dir $dir/data/index/en
make_dir $dir/data/index/es
make_dir $dir/data/misc
make_dir $dir/data/misc/en
make_dir $dir/data/misc/es
make_dir $dir/dest
make_dir $dir/dest/images
make_dir $dir/src
make_dir $dir/src/bodies
make_dir $dir/src/images
make_dir $dir/src/layout

# make AUTHORS

echo "$author <$address>" > "$dir/AUTHORS"

# make Makefile

if [ "$autoconv" == "y" ] ; then
  Makefile_text1="\
JPEG = .$jpeg
XPM = .$xpm"
  Makefile_text2="\
JPEG_FILES = \\
	\$(addprefix \$(DESTDIR)/images/, \$(addsuffix \$(JPEG), \\
	\$(notdir \$(basename \$(wildcard \$(SRCDIR)/images/*\$(XPM))))))"
  Makefile_text3="\
	\$(HTML_FILES) \\
	\$(JPEG_FILES)"
  Makefile_text4="all: \$(HTML_FILES) \$(JPEG_FILES)"
  Makefile_text5="\
\$(DESTDIR)/images/%\$(JPEG): \$(SRCDIR)/images/%\$(XPM)
	xpmtoppm \$< | ppmtojpeg > \$@"
else
  Makefile_text1=""
  Makefile_text2=""
  Makefile_text3="\
	\$(HTML_FILES)"
  Makefile_text4="all: \$(HTML_FILES)"
  Makefile_text5=""
fi

cat -s > "$dir/Makefile" <<EOF
# Makefile for build the site

HTEX = .$htex
HTML = .$html
$Makefile_text1

DESTDIR = dest
SRCDIR = src

HTMLEX = htmlex

ifdef DEPEND
  HTMLEX += -M
endif

HTML_FILES = \\
	\$(addprefix \$(DESTDIR)/, \$(addsuffix \$(HTML), \\
	\$(notdir \$(basename \$(wildcard \$(SRCDIR)/*\$(HTEX))))))

$Makefile_text2

CLEAN_FILES = \\
	Makefile.dep

DISTCLEAN_FILES = \\
$Makefile_text3

.PHONY: default all clean distclean depend

default: all

$Makefile_text4
	@echo Done!

clean:
	-rm -f \$(CLEAN_FILES)

distclean:
	-rm -f \$(CLEAN_FILES) \$(DISTCLEAN_FILES)

depend:
	-rm -f Makefile.dep
	make \$(HTML_FILES) DEPEND=1
	cat Makefile.dep | sed -e 's/^\$(SRCDIR)\/\(.*\)\$(HTEX):/\$(DESTDIR)\/\1\$(HTML):/g' > _depend.tmp
	mv _depend.tmp Makefile.dep

ifdef DEPEND

dummy_rule:

\$(DESTDIR)/%\$(HTML): \$(SRCDIR)/%\$(HTEX) dummy_rule
	\$(HTMLEX) \$< >> Makefile.dep

else

\$(DESTDIR)/%\$(HTML): \$(SRCDIR)/%\$(HTEX)
	\$(HTMLEX) \$< > \$@

-include Makefile.dep

endif

$Makefile_text5
EOF

# compress site utility

cat > "$dir/compress.sh" <<EOF
#! /bin/sh

tempfile=\`tempfile\`

for filename in dest/*.$html ; do
  cat "\$filename" \\
	| expand \\
	| tr -s '\n' \\
	| sed -e 's/^[ ]*//g' \\
	| tr -d '\r' \\
	> "\$tempfile"
   mv "\$tempfile" "\$filename"
done
EOF

chmod +x "$dir/compress.sh"

# rebuild site utility

cat > "$dir/rebuild.sh" <<EOF
#! /bin/sh

make distclean
make depend
make all

source compress.sh
EOF

chmod +x "$dir/rebuild.sh"

# upload site utility

cat > "$dir/upload.sh" <<EOF
#! /bin/sh

cd dest/

FTP_HOSTNAME=[insert-hostname]
FTP_USERNAME=[insert-username]
FTP_PASSWORD=[insert-password]

FTP_ASCII_FILES=\`find -name '*.$html' | sed -e 's/^\.\/\(.*\)/\1/'\`
FTP_BINARY_FILES=\`find -name '*.$jpeg' | sed -e 's/^\.\/\(.*\)/\1/'\`

ftp-upload \\
  --verbose \\
  --host	\$FTP_HOSTNAME \\
  --user	\$FTP_USERNAME \\
  --password	\$FTP_PASSWORD \\
  --ascii	\$FTP_ASCII_FILES \\
  --binary	\$FTP_BINARY_FILES

cd ../
EOF

chmod 700 "$dir/upload.sh"

# make data files

echo "Index"        > "$dir/data/index/en/title"
echo "Índice"       > "$dir/data/index/es/title"
echo "Index text"   > "$dir/data/index/en/text"
echo "Texto índice" > "$dir/data/index/es/text"

cat > "$dir/data/misc/en/foot" <<EOF
Copyright (C) \$DATE by \$AUTHOR<BR>
<A href="mailto:\$ADDRESS">\$ADDRESS</A>
EOF

cat > "$dir/data/misc/es/foot" <<EOF
Copyright (C) \$DATE por \$AUTHOR<BR>
<A href="mailto:\$ADDRESS">\$ADDRESS</A>
EOF

# make htmlex files

cat > "$dir/src/layout/macros.$htex" <<EOF
<!macro \$AUTHOR  "$author">
<!macro \$ADDRESS "$address">
<!macro \$DATE    "$date">
EOF

cat > "$dir/src/layout/head.$htex" <<EOF
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<HTML>
<HEAD>
<TITLE><!include data/\$NAME/\$LANG/title></TITLE>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<META name="description" content="[insert-description]">
<META name="keyword" content="[insert-keyword]">
</HEAD>
<BODY text="#000000" bgcolor="#ffffff" link="#0000ff" vlink="#ff00ff" alink="#0000ff">
EOF

cat > "$dir/src/layout/foot.$htex" <<EOF
<HR>
<DIV align="left"><ADDRESS><!include data/misc/\$LANG/foot></ADDRESS></DIV>
</BODY>
</HTML>
EOF

cat > "$dir/src/layout/body.$htex" <<EOF
<!macro \$LANG <!shift <!suffix <!arg1>>>>
<!macro \$NAME <!basename <!arg1>>>

<!include src/layout/macros.$htex>
<!include src/layout/head.$htex>
<!include src/bodies/\$NAME.$htex>
<!include src/layout/foot.$htex>
EOF

if [ "$autoconv" == "y" ] ; then
  text="<IMG src=\"images/logo.$jpeg\" alt=\"<!include data/index/\$LANG/title>\">"
else
  text="<!include data/index/\$LANG/title>"
fi

cat > "$dir/src/bodies/index.$htex" <<EOF
<DIV align="center">
$text
</DIV>

<P><!include data/index/\$LANG/text></P>
EOF

cat > "$dir/src/index.$htex" <<EOF
<!include src/layout/body.$htex index.en>
EOF

cat > "$dir/src/index.es.$htex" <<EOF
<!include src/layout/body.$htex index.es>
EOF

# make a image

if [ "$autoconv" == "y" ] ; then
cat > "$dir/src/images/logo.$xpm" <<EOF
/* XPM */
static char * logo_xpm[] = {
"64 16 3 1",
" 	c #FFFFFF",
".	c #7F7F7F",
"#	c #000000",
"                                                                ",
"                                                                ",
"  ####           ############   ############   ############     ",
"  ####.          ############.  ############.  ############.    ",
"  ####.          ############.  ############.  ############.    ",
"  ####.          ############.  ############.  ############.    ",
"  ####.          ####....####.  ####.........  ####....####.    ",
"  ####.          ####.   ####.  ####.          ####.   ####.    ",
"  ####.          ####.   ####.  ####.   ####   ####.   ####.    ",
"  ####.          ####.   ####.  ####.   ####.  ####.   ####.    ",
"  ############.  ############.  ############.  ############.    ",
"  ############.  ############.  ############.  ############.    ",
"  ############.  ############.  ############.  ############.    ",
"  ############.  ############.  ############.  ############.    ",
"   ............   ............   ............   ............    ",
"                                                                "};
EOF
fi
